---
title: Comparison of submissions from this repository and the NowcastHub
author: Stefan Heyder
date: 2023-06-21
---

This Rmarkdown file compares the nowcasts created by this repository with the ones submitted to the hub. 
We will look at the maximal difference in submitted predicted quantiles for every date of submission.
Some differences are to be expected:

- the nowcasts in this repository use the most recent data and sometimes (though not often) there are retrospective changes to the case and hospitalisation data and
- the model has changed at several points in the past, with a big change on 18. November 2021 and smaller changes on 08.12 2021.

Other than that we expect these differences to be minor. 

```{r, echo=F, message=F, warning=F}
# Install necessary packages if not already installed
list_of_packages <- c("httr", "jsonlite")
new_packages <- list_of_packages[!(list_of_packages %in% installed.packages()[,"Package"])]
if(length(new_packages)) install.packages(new_packages)

# Load necessary libraries
library(httr)
library(here)
library(jsonlite)
library(tidyverse)
library(lubridate)



list_github_subdirectory <- function(user, repo, subdir) {
  url <- paste0('https://api.github.com/repos/', user, '/', repo, '/contents/', subdir)
  
  # Send a GET request to the GitHub API
  response <- GET(url)
  
  # Check the status of the response
  if(http_status(response)$category != "Success") {
    stop("Failed to retrieve data from GitHub API. Please check the username, repository name and subdirectory.")
  }
  
  # Parse the JSON response
  contents <- fromJSON(content(response, "text", encoding = "UTF-8"))
  
  contents
}

ILM_prop_contents <- list_github_subdirectory("KITmetricslab", "hospitalization-nowcast-hub", "data-processed/ILM-prop")  %>%
    as_tibble

available_dates_gh <- ILM_prop_contents %>%
    filter(str_starts(name, "20")) %>%
    pull(name) %>%
    str_sub(end = 10) %>%
    ymd 

retrospective_submissions <- read_csv(here("data/processed/submissions-ILM-prop.csv"))

available_dates_submissions <- retrospective_submissions %>%
    distinct(forecast_date) %>%
    deframe

available_dates <- ymd(
   # intersect converts dates to numbers
    intersect(
        as.character(available_dates_gh),
        as.character(available_dates_submissions)
    )
)
```


```{r, echo=F}
read_gh <- function(date) {
    url <- str_glue("https://raw.githubusercontent.com/KITmetricslab/hospitalization-nowcast-hub/main/data-processed/ILM-prop/{date}-ILM-prop.csv")

    read_csv(url, show_col_types = FALSE)
}

dates <- sample(available_dates, 30) # random sample to check reproducibility
dates <- available_dates # use all dates, takes a lot longer

gh_submission <- lapply(dates, read_gh) %>%
    do.call(rbind, .)
```

```{r, echo=F}
compare_df <- retrospective_submissions %>% 
    filter(forecast_date %in% dates) %>%
    inner_join(gh_submission, by = c("forecast_date", "target_end_date", "age_group", "quantile"), suffix = c("_this", "_gh"))%>%
    mutate(rel_diff = (value_this - value_gh) / value_gh) %>%
    mutate(diff = value_this - value_gh)  %>%
    mutate(month = factor(floor_date(forecast_date, "month"))) 

```
Below are a monthly comparison of relative and absolute differernces between the nowcasts produced by this repository and the ones submitted to the NowcastHub on a monthly basis, split by quantile and age-group.

The deviations are mostly minor, except for the period where another model was run (end of 2021) and relative errors in the younger age group; but there hospitalisations are low and already small absolute discrepancies (second figure) may lead to large relative discrepancies.
```{r, echo=F, fig.height=10, dpi=300}
compare_df %>% 
    filter(quantile %in% c(.025, .975, .5)) %>%
    ggplot(aes(month, abs(rel_diff * 100))) +
    geom_boxplot() +
    geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
    facet_grid(age_group~quantile) +
    ylab("absolute relative error between submissions and this repositories nowcasts (%)") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
    coord_cartesian(ylim = c(0, 10))

```

\newpage

```{r, echo=F, fig.height=10, dpi=300}
compare_df %>% 
    filter(quantile %in% c(.025, .975, .5)) %>%
    filter(age_group != "00+") %>%
    ggplot(aes(month, abs(diff))) +
    geom_boxplot() +
    geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
    facet_grid(age_group~quantile) +
    ylab("absolute error between submissions and this repositories nowcasts") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
    coord_cartesian(ylim = c(0, 100))
```
